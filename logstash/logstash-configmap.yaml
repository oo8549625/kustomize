apiVersion: v1
kind: ConfigMap
metadata:
  name: logstash-config
  labels:
    app.kubernetes.io/name: elasticsearch-logstash
    app.kubernetes.io/component: logstash
data:
  logstash.yml: |
    http.host: 0.0.0.0
    pipeline.ecs_compatibility: disabled
  pipelines.yml: |
    - pipeline.id: logstash
      path.config: "/usr/share/logstash/pipeline/logstash.conf"
 
  log4j2.properties: |
    logger.logstashpipeline.name = logstash.inputs.beats
    logger.logstashpipeline.level = error
 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: logstash-pipeline
  labels:
    app.kubernetes.io/name: elasticsearch-logstash
    app.kubernetes.io/component: logstash
data:
  logstash.conf: |
    input {
      kafka {
        topics => ["nbcdn-access"] 
        bootstrap_servers => "172.16.1.20:9092,172.16.1.16:9092,172.16.1.17:9092"
        group_id => "nbcdn-access"
        consumer_threads => 1
        auto_offset_reset => "latest"
        type => "access"
      }
    }
    filter {
      json {
        source => "message"
      }
      date {
        match => ["time", "ISO8601"]
        target => "@timestamp"
      }
    }
    output {
      elasticsearch {
        template_name => "logstash"
        ilm_enabled => "true"
        ilm_rollover_alias => "logstash"
        ilm_pattern => "{now/d}-000001"
        ilm_policy => "logstash-policy"
        hosts => [ "${ES_HOSTS}" ]
        user => "${ES_USER}"
        password => "${ES_PASSWORD}"
        cacert => '/etc/logstash/certificates/ca.crt'
      }
    }